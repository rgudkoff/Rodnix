/**
 * @file interrupts.h
 * @brief Архитектурно-независимый интерфейс для прерываний
 * 
 * Определяет абстракции для работы с прерываниями, которые
 * реализуются в архитектурно-зависимых модулях.
 */

#ifndef _RODNIX_CORE_INTERRUPTS_H
#define _RODNIX_CORE_INTERRUPTS_H

#include "arch_types.h"
#include <stdint.h>
#include <stdbool.h>

/* ============================================================================
 * Типы прерываний
 * ============================================================================ */

typedef enum {
    INTERRUPT_TYPE_EXCEPTION = 0,  /* Исключение процессора */
    INTERRUPT_TYPE_IRQ,            /* Аппаратное прерывание */
    INTERRUPT_TYPE_SOFTWARE,        /* Программное прерывание */
    INTERRUPT_TYPE_SYSCALL,         /* Системный вызов */
} interrupt_type_t;

/* ============================================================================
 * Контекст прерывания (архитектурно-независимый)
 * ============================================================================ */

typedef struct interrupt_context {
    uint64_t pc;           /* Program Counter / Instruction Pointer */
    uint64_t sp;           /* Stack Pointer */
    uint64_t flags;        /* Флаги состояния */
    uint64_t error_code;   /* Код ошибки (если есть) */
    uint32_t vector;       /* Номер вектора прерывания */
    interrupt_type_t type;  /* Тип прерывания */
    void* arch_specific;   /* Архитектурно-зависимые данные */
} interrupt_context_t;

/* ============================================================================
 * Обработчик прерывания
 * ============================================================================ */

typedef void (*interrupt_handler_t)(interrupt_context_t* ctx);

/* ============================================================================
 * Уровень прерывания (IRQL)
 * ============================================================================ */

typedef enum {
    IRQL_PASSIVE = 0,      /* Обычный уровень (прерывания разрешены) */
    IRQL_APC,              /* Asynchronous Procedure Call */
    IRQL_DISPATCH,         /* Уровень диспетчеризации */
    IRQL_DEVICE,           /* Уровень устройств */
    IRQL_CLOCK,            /* Уровень часов */
    IRQL_IPI,              /* Inter-Processor Interrupt */
    IRQL_HIGH,             /* Высокий уровень (все прерывания заблокированы) */
} irql_t;

/* ============================================================================
 * Функции инициализации
 * ============================================================================ */

/**
 * Инициализация подсистемы прерываний
 * @return 0 при успехе, отрицательное значение при ошибке
 */
int interrupts_init(void);

/**
 * Регистрация обработчика прерывания
 * @param vector Номер вектора прерывания
 * @param handler Обработчик прерывания
 * @return 0 при успехе, отрицательное значение при ошибке
 */
int interrupt_register(uint32_t vector, interrupt_handler_t handler);

/**
 * Удаление обработчика прерывания
 * @param vector Номер вектора прерывания
 * @return 0 при успехе, отрицательное значение при ошибке
 */
int interrupt_unregister(uint32_t vector);

/* ============================================================================
 * Управление прерываниями
 * ============================================================================ */

/**
 * Включение прерываний
 */
void interrupts_enable(void);

/**
 * Выключение прерываний
 */
void interrupts_disable(void);

/**
 * Получение текущего уровня прерываний
 * @return Текущий IRQL
 */
irql_t get_current_irql(void);

/**
 * Установка уровня прерываний
 * @param new_level Новый уровень IRQL
 * @return Предыдущий уровень IRQL
 */
irql_t set_irql(irql_t new_level);

/**
 * Ожидание прерывания (HLT или аналогичная инструкция)
 */
void interrupt_wait(void);

/* ============================================================================
 * Межпроцессорные прерывания (IPI)
 * ============================================================================ */

/**
 * Отправка IPI (Inter-Processor Interrupt)
 * @param cpu_id ID целевого процессора
 * @param vector Номер вектора прерывания
 * @return 0 при успехе, отрицательное значение при ошибке
 */
int interrupt_send_ipi(uint32_t cpu_id, uint32_t vector);

#endif /* _RODNIX_CORE_INTERRUPTS_H */

